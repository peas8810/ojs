<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    :root{
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --muted2:#9ca3af;
      --accent:#1f77b4; /* pode trocar por outra cor depois */
    }
    body{margin:0;font-family:Arial,system-ui;background:#fff;}
    .card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px 10px;
      background:#fff;
    }
    .hdr{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .title{
      font-size:13px;
      font-weight:700;
      color:var(--text);
      line-height:1.15;
    }
    .pill{
      font-size:10px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:3px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:6px 0 6px;
    }
    .stat{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:92px;
    }
    .k{
      font-size:10px;
      color:var(--muted);
      letter-spacing:.02em;
    }
    .v{
      font-size:14px;
      font-weight:800;
      color:var(--text);
      line-height:1.05;
    }
    .spark{
      margin-top:6px;
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px 8px 2px;
    }
    canvas{width:100% !important; height:58px !important;}
    .foot{
      margin-top:6px;
      font-size:10px;
      color:var(--muted2);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    a{color:inherit;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>

<div class="card">
  <div class="hdr">
    <div class="title">Scilit Metrics</div>
    <div class="pill">Sparkline</div>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="k">h5-index</div>
      <div class="v" id="h5">—</div>
    </div>
    <div class="stat">
      <div class="k">MCM</div>
      <div class="v" id="mcm">—</div>
    </div>
  </div>

  <div class="spark">
    <canvas id="spark"></canvas>
  </div>

  <div class="foot">
    <div>Atualização: <span id="updated">—</span></div>
    <div><a href="https://www.scilit.com/sources/96056" target="_blank" rel="noopener">Ver no Scilit</a></div>
  </div>
</div>

<script>
(async function(){
  const DATA_URL = "https://raw.githubusercontent.com/peas8810/ojs/main/remunom-scilit.json";

  const h5El = document.getElementById("h5");
  const mcmEl = document.getElementById("mcm");
  const updEl = document.getElementById("updated");

  function fmt(n){
    if(n === null || n === undefined || n === "") return "—";
    const x = Number(n);
    if(Number.isNaN(x)) return String(n);
    // 0.42 -> 0.42 | 11 -> 11
    return (Math.abs(x) < 1 && x !== 0) ? x.toFixed(2) : (Number.isInteger(x) ? String(x) : x.toFixed(2));
  }

  try{
    const res = await fetch(DATA_URL + "?t=" + Date.now(), { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);

    const data = await res.json();

    h5El.textContent = fmt(data.h5_index);
    mcmEl.textContent = fmt(data.mcm);
    updEl.textContent = data.updated_at ?? "—";

    const series = Array.isArray(data.series) ? data.series : [];
    const labels = series.map(p => p.month);
    const values = series.map(p => Number(p.value));

    const validValues = values.filter(v => Number.isFinite(v));
    const min = validValues.length ? Math.min(...validValues) : 0;
    const max = validValues.length ? Math.max(...validValues) : 1;
    const pad = (max - min) * 0.12 || 0.05;

    const lastIndex = values.length - 1;

    new Chart(document.getElementById("spark"), {
      type: "line",
      data: {
        labels,
        datasets: [{
          data: values,
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),
          borderWidth: 2,
          tension: 0.35,
          fill: false,
          pointRadius: (ctx) => ctx.dataIndex === lastIndex ? 3.5 : 0,
          pointHoverRadius: (ctx) => ctx.dataIndex === lastIndex ? 5 : 3,
          pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),
          pointBorderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            displayColors: false,
            callbacks: {
              title: (items) => items?.[0]?.label || "",
              label: (item) => "MCM: " + fmt(item.raw)
            }
          }
        },
        scales: {
          x: { display: false, grid: { display: false } },
          y: {
            display: false,
            min: min - pad,
            max: max + pad,
            grid: { display: false }
          }
        },
        elements: { line: { capBezierPoints: true } }
      }
    });

  } catch(e){
    h5El.textContent = "—";
    mcmEl.textContent = "—";
    updEl.textContent = "—";
    console.log(e);
  }
})();
</script>

</body>
</html>
